#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# 1. Lint-staged (formata√ß√£o e lint em arquivos staged)
pnpm lint-staged

# 2. Testes unit√°rios r√°pidos
# Skip se SKIP_TESTS estiver definido ou se estiver em modo --no-verify
if [ -z "${SKIP_TESTS:-}" ] && [ "$HUSKY" != "0" ]; then
  echo ""
  echo "üß™ Rodando testes unit√°rios..."
  
  # Tentar rodar testes via Docker (se dispon√≠vel) ou pnpm local
  if command -v docker &> /dev/null && docker compose ps &> /dev/null 2>&1; then
    # Docker-first: usar container tools
    docker compose run --rm -T tools pnpm test || {
      echo ""
      echo "‚ùå Testes falharam. Para pular testes, use: SKIP_TESTS=1 git commit"
      exit 1
    }
  elif command -v pnpm &> /dev/null; then
    # Fallback: pnpm local
    pnpm test || {
      echo ""
      echo "‚ùå Testes falharam. Para pular testes, use: SKIP_TESTS=1 git commit"
      exit 1
    }
  else
    echo "‚ö†Ô∏è  Docker e pnpm n√£o dispon√≠veis. Pulando testes."
  fi
fi
